{% macro prepareSimpleValue(valueName, field, root, propertyName) -%}
{%- endmacro %}

{% macro simpleValue(valueName, field, root, propertyName) -%}
{{valueName}}
{%- endmacro %}

{% macro prepareRefObjectValue(valueName, field, root, propertyName) -%}
const {{valueName}} = await (new {{utils.typeFor(field)}}(await {{valueName}}, this.ctx)).dump();
{%- endmacro %}

{%- macro refObjectValue(valueName, field, root, propertyName) -%}
(({{ valueName }}) && (await (new {{utils.typeFor(field)}}(await {{ valueName }}, this.ctx)).dump()))
{%- endmacro -%}

{%- macro prepareObjectValue(valueName, field, root, propertyName) -%}
{%- if root -%}
const [
{%- for propertyName, propertySchema in field.properties -%}
{{ propertyName }},
{%- endfor -%}
] = await Promise.all([
{%- for propertyName, propertySchema in field.properties -%}
{{ value(valueName+'.'+propertyName, propertySchema, false, propertyName) }},
{%- endfor -%}
]) as [
  {%- for propertyName, propertySchema in field.properties -%}
  {{utils.typeFor(propertySchema)}},
  {%- endfor -%}
];
{%- else -%}
{%- endif -%}
{% endmacro -%}

{% macro objectValue(valueName, field, root, propertyName) -%}
{% if root -%}
{ {% for propertyName, propertySchema in field.properties -%}
  {{ propertyName }}, {% endfor %}}
{%- else -%}
  ({{ valueName }} && (await (async ({{ propertyName }}) => {
    {{- prepareValue(propertyName, field, true) -}}
    return {{ value(propertyName, field, true) -}};})({{ valueName }})))
{%- endif -%}
{%- endmacro %}

{% macro prepareArrayValue(valueName, field, root, propertyName) -%}
{%- endmacro %}

{% macro arrayValue(valueName, field, root, propertyName) -%}
(await Promise.all((await {{valueName}} || []).map(async item => ({{ value('item', field.items, false, propertyName) }}))))
{%- endmacro %}

{%- macro value(valueName, field, root, propertyName) -%}

{%- if field.type === 'array' -%}
{{ arrayValue(valueName, field, root, propertyName) }}
{%- elif field.$ref -%}
{{ refObjectValue(valueName, field, root, propertyName) }}
{%- elif field.type === 'object' and field.properties -%}
{{ objectValue(valueName, field, root, propertyName) }}
{%- else -%}
{{ simpleValue(valueName, field, root, propertyName) }}
{%- endif -%}

{%- endmacro -%}

{% macro assignValue(resultName, valueName, field) %}
{{resultName}} = {{ value(valueName, field) }};
{% endmacro %}

{% macro prepareValue(valueName, field, root) -%}
{%- if field.type === 'array' -%}
{{ prepareArrayValue(valueName, field, root) }}
{%- elif field.$ref -%}
{{ prepareRefObjectValue(valueName, field, root) }}
{%- elif field.type === 'object' and field.properties -%}
{{ prepareObjectValue(valueName, field, root) }}
{%- else -%}
{{ prepareSimpleValue(valueName, field, root) }}
{%- endif -%}

{% endmacro %}
